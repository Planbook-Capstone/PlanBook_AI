name: Deploy PlanBook AI to VPS

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            echo " Moving to project folder"
            cd PlanBook_AI || exit 1

            echo " Pulling latest code"
            git reset --hard
            git pull origin master || git pull origin main

            echo "üèóÔ∏è Building new Docker images (keeping old containers running)..."
            if ! docker compose -f docker-compose.yml build; then
              echo "‚ùå Build failed. Keeping current containers running."
              exit 1
            fi

            echo "‚úÖ Build successful. Stopping old containers..."
            docker compose -f docker-compose.yml down

            echo "üöÄ Starting new containers..."
            docker compose -f docker-compose.yml up -d

            echo "‚è≥ Waiting for FastAPI to be ready..."
            sleep 30

            for i in {1..15}; do
              if curl -fs http://localhost:8000/health; then
                echo "‚úÖ Deployment successful!"
                docker image prune -f
                exit 0
              fi
              echo "‚è≥ Waiting... ($i/15)"
              sleep 4
            done

            echo "‚ùå Health check failed. Rolling back..."
            docker compose -f docker-compose.yml down
            exit 1
